stages:
  - trigger

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

variables:
  DEPLOY_INFRA:
    value: "false"
    options:
      - "false"
      - "true"
    description: "Run the infrastructure child pipeline"
  DEPLOY_APPS:
    value: "false"
    options:
      - "false"
      - "true"
    description: "Run the applications child pipeline"

infrastructure:
  stage: trigger
  trigger:
    include: infrastructure/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: '$DEPLOY_INFRA == "true"'
    - changes: 
        - infrastructure/**/*

applications:
  stage: trigger
  needs:
    - job: infrastructure
      optional: true
  trigger:
    include: applications/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: '$DEPLOY_APPS == "true"'
    - changes: 
        - applications/**/*
