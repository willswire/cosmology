stages:
  - trigger
  - deploy

variables:
  TARGET:
    description: "the configuration target"
    value: "infrastructure"
    options:
      - "toolbox"
      - "infrastructure"
      - "cluster"

workflow:
  rules:
    - if: "$CI_PIPELINE_SOURCE == 'web'"

toolbox:
  stage: trigger
  trigger:
    include: toolbox/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: "$TARGET == 'toolbox'"

infrastructure:
  stage: trigger
  needs:
    - job: toolbox
      optional: true
  trigger:
    include: infrastructure/.gitlab-ci.yml
    strategy: depend
  rules:
    - if: "$TARGET == 'infrastructure'"

deploy:
  image: $CI_REGISTRY_IMAGE/toolbox
  stage: deploy
  script:
    - mkdir -p $HOME/.kube
    - mv $KUBE_CONFIG $HOME/.kube/config
    - bash $CI_PROJECT_DIR/deploy.sh
  rules:
    - if: "$TARGET == 'cluster'"
