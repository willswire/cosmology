##
# GLOBAL CONFIGURATIONS
##
domain: tatooine.dev

registryCredentials:
  - registry: registry1.dso.mil
    username: "" # set in secrets overlay
    password: "" # set in secrets overlay
    email: ""    # this can stay empty
  - registry: registry.gitlab.com
    username: "" # set in secrets overlay
    password: "" # set in secrets overlay
    email: ""    # this can stay empty

##
# SERVICE MESH (Istio, Kiali)
##
istio:
  enabled: true
  gateways:
    public:
      tls:
        mode: MUTUAL
        cert: "" # set in secrets overlay
        key: ""  # set in secrets overlay
        ca: ""   # set in secrets overlay
  values:
    hub: cgr.dev/chainguard
    tag: latest
    values:
      pilot: 
        image: istio-pilot
      global:
        proxy:
          image: istio-proxy

istioOperator:
  enabled: true
  values:
    hub: cgr.dev/chainguard
    image: istio-operator
    tag: latest

kiali:
  enabled: false

##
# LOGGING (Loki, Promtail)
##
loki:
  enabled: false

promtail:
  enabled: false

##
# POLICY ENFORCEMENT (Kyverno)
##
kyverno:
  enabled: true
  values:
    image:
     registry: cgr.dev
     repository: chainguard/kyverno
     tag: latest
    initImage:
      registry: cgr.dev
      repository: chainguard/kyvernopre
      tag: latest

kyvernoPolicies:
  enabled: false
  values:
    policies:
      disallow-image-tags:
        validationFailureAction: audit
      disallow-shared-subpath-volume-writes:
        validationFailureAction: audit
      restrict-host-ports:
        validationFailureAction: audit
      restrict-capabilities:
        validationFailureAction: audit
      restrict-image-registries:
        validationFailureAction: audit
      disallow-host-namespaces:
        validationFailureAction: audit
      disallow-privileged-containers:
        validationFailureAction: audit
      require-non-root-user:
        validationFailureAction: audit
      restrict-host-path-mount-pv:
        validationFailureAction: audit

kyvernoReporter:
  enabled: false

##
# MONITORING (Prometheus, Grafana)
##
monitoring:
  enabled: true
  values:
    alertmanager:
      alertmanagerSpec:
        image:
          repository: cgr.dev/chainguard/prometheus-alertmanager
          tag: latest
    grafana:
      sidecar:
        image:
          repository: cgr.dev/chainguard/k8s-sidecar
          tag: latest
        resources:
          limits:
            cpu: 500m
            memory: 500Mi
          requests:
            cpu: 100m
            memory: 100Mi
    kube-state-metrics:
      image:
        registry: cgr.dev
        repository: chainguard/kube-state-metrics
        tag: latest
    prometheus:
      prometheusSpec:
        image:
          repository: cgr.dev/chainguard/prometheus
          tag: latest
    prometheusOperator:
      image:
        registry: cgr.dev
        repository: chainguard/prometheus-operator
        tag: latest
      thanosImage:
        registry: cgr.dev
        repository: chainguard/thanos
        tag: latest
      prometheusConfigReloader:
        image:
          registry: cgr.dev
          repository: chainguard/prometheus-config-reloader
          tag: latest
    ## mismatching node exporter version tag from chainguard (semverCompare issue)
    ## https://github.com/prometheus-community/helm-charts/blob/6df9ef36a6eea543fef3188e1357e6d63287efd5/charts/prometheus-node-exporter/templates/daemonset.yaml#L52
    ## requires a re-tagged image with a semver compatible value
    prometheus-node-exporter:
      image:
        registry: registry.gitlab.com
        repository: willswire/cosmology/chainguard/prometheus-node-exporter
        tag: v1.6.1
    thanosRuler:
      thanosRulerSpec:
        image:
          registry: cgr.dev
          repository: chainguard/thanos
          tag: latest

grafana:
  enabled: false
  values:
    sidecar:
      image:
        repository: cgr.dev/chainguard/k8s-sidecar
        tag: latest
      resources:
        limits:
          cpu: 500m
          memory: 500Mi
        requests:
          cpu: 100m
          memory: 100Mi

##
# DISTRIBUTED TRACING (Tempo)
##
tempo:
  enabled: false

##
# RUNTIME SECURITY (Neuvector)
##
neuvector:
  enabled: false

##
# CUSTOM PACKAGES
##
helmRepositories:
  - name: cosmology-packages
    repository: "oci://registry.gitlab.com/willswire/cosmology/packages"
    existingSecret: "private-registry"
    type: "oci"
  - name: shadows-edge-packages
    repository: "oci://registry.gitlab.com/90cos"
    existingSecret: "private-registry"
    type: "oci"

packages:
  gitlab-agent:
    enabled: true
    wrapper:
      enabled: true
    git:
      repo: https://gitlab.com/gitlab-org/charts/gitlab-agent.git
      tag: v1.20.0
      path: ./
    values:
      config:
        token: "" # set in secrets overlay
        kasAddress: wss://kas.gitlab.com
  clip:
    enabled: true
    wrapper:
      enabled: true
    helmRepo:
      repoName: cosmology-packages
      chartName: clip
      tag: 0.2.0
    dependsOn:
      - name: istio
        namespace: bigbang
    secrets:
      - name: cloudflare-credentials
        data:
          AUTH_KEY: "" # set in secrets overlay
          ZONE_ID: ""  # set in secrets overlay
  shadow-llama:
    enabled: true
    wrapper:
      enabled: true
    helmRepo:
      repoName: shadows-edge-packages
      chartName: shadow-llama
      tag: 0.1.2
    dependsOn:
      - name: istio
        namespace: bigbang
    values:
      domain: tatooine.dev
      gateway: istio-system/public
      apiServer:
        enableGPU: true
        replicas: 1
        tolerations:
          - key: sku
            operator: Equal
            value: gpu
            effect: NoSchedule
        nodeSelector:
          node_type: gpu
        resources:
          limits:
            memory: "16Gi"
            cpu: "2"
          requests:
            memory: "8Gi"
            cpu: "1"
      codey:
        model: "mistral:7b-instruct"
        gitlabUrl: "https://gitlab.com"
    secrets:
      - name: codey-credentials
        data:
          CODEY_THE_MAGICAL_BOT_USERNAME: "" # set in secrets overlay
          GITLAB_API_KEY: ""  # set in secrets overlay